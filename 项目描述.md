# DormDB 项目详细描述文档

## 📋 项目概述

### 项目背景
DormDB (Database on Request Management Database) 是一个专为教育机构、开发团队或任何需要快速分配数据库资源的场景设计的自助服务平台。传统的数据库申请流程往往需要人工干预，耗时且容易出错。DormDB 通过全自动化的方式，让用户能够在几秒钟内获得一个完全配置好的 MySQL 数据库实例。

### 设计理念
- **安全第一**: 每个用户获得的数据库权限严格限制，无法影响其他用户或系统
- **简单易用**: 用户只需提供身份标识，其余全部自动化处理
- **高度可靠**: 完整的事务处理和错误回滚机制
- **透明监控**: 完整的操作日志和状态监控

## 🎯 核心功能

### 1. 用户自助申请系统
- **身份验证**: 基于唯一身份标识（如学号、工号）的申请系统
- **防重复机制**: 自动检测重复申请，避免资源浪费
- **即时响应**: 申请成功后立即返回完整的数据库连接信息
- **友好界面**: 简洁的 Web 界面，支持一键复制连接信息

### 2. 自动化数据库管理
- **动态创建**: 根据身份标识自动生成数据库名和用户名
- **安全密码**: 自动生成高强度随机密码
- **权限控制**: 精确的权限分配，确保用户只能操作自己的数据库
- **资源隔离**: 每个用户拥有完全独立的数据库空间

### 3. 管理员监控系统
- **实时状态**: 系统运行状态、数据库连接状态实时监控
- **申请统计**: 总申请数量、今日申请数量等统计信息
- **用户管理**: 查看所有已申请用户的详细信息
- **数据一致性**: 自动检测和修复数据不一致问题

## 🏗️ 技术架构

### 后端技术栈
- **Rust**: 高性能、内存安全的系统编程语言
- **Actix-Web**: 高性能的异步 Web 框架
- **SQLx**: 类型安全的异步 SQL 工具包
- **MySQL**: 主要的数据库管理系统
- **SQLite**: 轻量级的状态存储数据库

### 前端技术栈
- **原生 HTML/CSS/JavaScript**: 简洁高效的用户界面
- **响应式设计**: 支持各种设备和屏幕尺寸
- **实时反馈**: 即时的操作结果展示

### 架构特点
- **微服务设计**: 清晰的模块分离，易于维护和扩展
- **异步处理**: 全异步架构，高并发性能
- **事务安全**: 完整的 ACID 事务支持
- **错误恢复**: 自动回滚和数据一致性保证

## 🔒 安全设计

### 权限隔离策略
1. **数据库级隔离**: 每个用户拥有独立的数据库
2. **用户级隔离**: 每个用户只能使用自己的数据库账号
3. **主机限制**: 严格限制连接来源主机
4. **权限最小化**: 只授予必要的数据操作权限

### 安全防护措施
- **SQL 注入防护**: 使用参数化查询和输入验证
- **权限提升防护**: 禁止用户创建新用户或数据库
- **跨库访问防护**: 严格限制用户只能访问自己的数据库
- **系统表保护**: 禁止访问 MySQL 系统数据库

### 审计和监控
- **操作日志**: 记录所有关键操作和安全事件
- **状态监控**: 实时监控系统和数据库状态
- **异常告警**: 自动检测和报告异常情况

## 📊 数据模型

### SQLite 状态数据库
```sql
CREATE TABLE applicants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    identity_key TEXT UNIQUE NOT NULL,     -- 用户身份标识
    db_name TEXT NOT NULL,                 -- 分配的数据库名
    db_user TEXT NOT NULL,                 -- 分配的用户名
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### MySQL 动态数据库
- **数据库命名规则**: `db_{identity_key}`
- **用户命名规则**: `user_{identity_key}`
- **权限范围**: 仅限指定数据库的 SELECT, INSERT, UPDATE, DELETE, INDEX, LOCK TABLES

## 🔄 业务流程

### 申请流程
1. **用户提交申请**: 在 Web 界面输入身份标识
2. **唯一性检查**: 系统检查该身份标识是否已申请过
3. **密码生成**: 自动生成高强度随机密码
4. **数据库创建**: 在 MySQL 中创建新数据库
5. **用户创建**: 创建对应的数据库用户
6. **权限分配**: 授予安全的数据库操作权限
7. **记录保存**: 在 SQLite 中保存申请记录
8. **结果返回**: 向用户返回完整的连接信息

### 错误处理流程
1. **错误检测**: 在任何步骤发生错误时立即检测
2. **事务回滚**: 自动回滚已执行的操作
3. **状态清理**: 清理可能产生的不一致状态
4. **错误报告**: 记录详细的错误信息
5. **用户反馈**: 向用户返回友好的错误信息

## 🚀 部署方案

### 开发环境
- 本地 MySQL 实例
- SQLite 文件存储
- 开发模式日志

### 生产环境
- 高可用 MySQL 集群
- 持久化存储
- 生产级日志和监控
- 负载均衡和容错

### 容器化部署
```dockerfile
# 支持 Docker 容器化部署
FROM rust:1.70 as builder
# ... 构建步骤

FROM debian:bookworm-slim
# ... 运行时环境
```

## 📈 性能特性

### 并发处理
- **异步架构**: 支持高并发请求处理
- **连接池**: 数据库连接池优化
- **资源管理**: 智能的资源分配和回收

### 响应时间
- **申请处理**: 通常在 1-3 秒内完成
- **状态查询**: 毫秒级响应
- **批量操作**: 支持批量处理优化

## 🔧 配置管理

### 环境变量配置
```bash
# 服务器配置
SERVER_HOST=127.0.0.1
SERVER_PORT=3000

# 数据库配置
MYSQL_HOST=your-mysql-host
MYSQL_PORT=3306
MYSQL_USERNAME=admin_user
MYSQL_PASSWORD=secure_password
MYSQL_ALLOWED_HOST=localhost

# 存储配置
SQLITE_PATH=./dormdb_state.db
```

### 配置验证
- 启动时自动验证所有必需配置
- 安全配置检查（如禁止通配符主机）
- 配置摘要显示

## 📚 API 设计

### RESTful API
- **标准 HTTP 方法**: GET, POST 等
- **统一响应格式**: 标准的 JSON 响应结构
- **错误码体系**: 完整的业务错误码定义
- **版本控制**: API 版本化支持

### OpenAPI 文档
- **Swagger UI**: 交互式 API 文档
- **自动生成**: 基于代码注解自动生成
- **实时更新**: 代码变更自动同步文档

## 🎨 用户体验

### Web 界面设计
- **简洁明了**: 最小化的用户界面
- **即时反馈**: 实时的操作状态显示
- **错误提示**: 友好的错误信息展示
- **响应式**: 支持移动设备访问

### 管理员界面
- **状态监控**: 实时的系统状态展示
- **数据统计**: 直观的统计图表
- **操作日志**: 详细的操作历史记录

## 🔮 未来规划

### 功能扩展
- **多数据库支持**: PostgreSQL, MongoDB 等
- **资源配额**: 用户资源使用限制
- **备份恢复**: 自动备份和恢复功能
- **监控告警**: 更完善的监控和告警系统

### 性能优化
- **缓存机制**: Redis 缓存支持
- **分布式部署**: 多节点部署支持
- **负载均衡**: 智能负载分配

---

DormDB 致力于为用户提供最安全、最便捷的数据库自助申请体验。
