var N=Object.defineProperty;var T=t=>{throw TypeError(t)};var x=(t,n,r)=>n in t?N(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r;var A=(t,n,r)=>x(t,typeof n!="symbol"?n+"":n,r),B=(t,n,r)=>n.has(t)||T("Cannot "+r);var m=(t,n,r)=>(B(t,n,"read from private field"),r?r.call(t):n.get(t)),R=(t,n,r)=>n.has(t)?T("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(t):n.set(t,r);import{i as j,A as $}from"./f-SsayYv.js";import{aa as F,r as q,ab as E,n as L,ac as P,ad as V,O as M,a4 as C}from"./UuX0VwB7.js";function I(t){return typeof t=="string"?`'${t}'`:new J().serialize(t)}const J=function(){var n;class t{constructor(){R(this,n,new Map)}compare(e,i){const o=typeof e,s=typeof i;return o==="string"&&s==="string"?e.localeCompare(i):o==="number"&&s==="number"?e-i:String.prototype.localeCompare.call(this.serialize(e,!0),this.serialize(i,!0))}serialize(e,i){if(e===null)return"null";switch(typeof e){case"string":return i?e:`'${e}'`;case"bigint":return`${e}n`;case"object":return this.$object(e);case"function":return this.$function(e)}return String(e)}serializeObject(e){const i=Object.prototype.toString.call(e);if(i!=="[object Object]")return this.serializeBuiltInType(i.length<10?`unknown:${i}`:i.slice(8,-1),e);const o=e.constructor,s=o===Object||o===void 0?"":o.name;if(s!==""&&globalThis[s]===o)return this.serializeBuiltInType(s,e);if(typeof e.toJSON=="function"){const a=e.toJSON();return s+(a!==null&&typeof a=="object"?this.$object(a):`(${this.serialize(a)})`)}return this.serializeObjectEntries(s,Object.entries(e))}serializeBuiltInType(e,i){const o=this["$"+e];if(o)return o.call(this,i);if(typeof(i==null?void 0:i.entries)=="function")return this.serializeObjectEntries(e,i.entries());throw new Error(`Cannot serialize ${e}`)}serializeObjectEntries(e,i){const o=Array.from(i).sort((a,c)=>this.compare(a[0],c[0]));let s=`${e}{`;for(let a=0;a<o.length;a++){const[c,u]=o[a];s+=`${this.serialize(c,!0)}:${this.serialize(u)}`,a<o.length-1&&(s+=",")}return s+"}"}$object(e){let i=m(this,n).get(e);return i===void 0&&(m(this,n).set(e,`#${m(this,n).size}`),i=this.serializeObject(e),m(this,n).set(e,i)),i}$function(e){const i=Function.prototype.toString.call(e);return i.slice(-15)==="[native code] }"?`${e.name||""}()[native]`:`${e.name}(${e.length})${i.replace(/\s*\n\s*/g,"")}`}$Array(e){let i="[";for(let o=0;o<e.length;o++)i+=this.serialize(e[o]),o<e.length-1&&(i+=",");return i+"]"}$Date(e){try{return`Date(${e.toISOString()})`}catch{return"Date(null)"}}$ArrayBuffer(e){return`ArrayBuffer[${new Uint8Array(e).join(",")}]`}$Set(e){return`Set${this.$Array(Array.from(e).sort((i,o)=>this.compare(i,o)))}`}$Map(e){return this.serializeObjectEntries("Map",e.entries())}}n=new WeakMap;for(const r of["Error","RegExp","URL"])t.prototype["$"+r]=function(e){return`${r}(${e})`};for(const r of["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"])t.prototype["$"+r]=function(e){return`${r}[${e.join(",")}]`};for(const r of["BigInt64Array","BigUint64Array"])t.prototype["$"+r]=function(e){return`${r}[${e.join("n,")}${e.length>0?"n":""}]`};return t}();function H(t,n){return t===n||I(t)===I(n)}function G(t,n){if(typeof t!="string")throw new TypeError("argument str must be a string");const r={},e=n||{},i=e.decode||X;let o=0;for(;o<t.length;){const s=t.indexOf("=",o);if(s===-1)break;let a=t.indexOf(";",o);if(a===-1)a=t.length;else if(a<s){o=t.lastIndexOf(";",s-1)+1;continue}const c=t.slice(o,s).trim();if(e!=null&&e.filter&&!(e!=null&&e.filter(c))){o=a+1;continue}if(r[c]===void 0){let u=t.slice(s+1,a).trim();u.codePointAt(0)===34&&(u=u.slice(1,-1)),r[c]=Y(u,i)}o=a+1}return r}function X(t){return t.includes("%")?decodeURIComponent(t):t}function Y(t,n){try{return n(t)}catch{return t}}const S=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function U(t,n,r){const e=r||{},i=e.encode||encodeURIComponent;if(typeof i!="function")throw new TypeError("option encode is invalid");if(!S.test(t))throw new TypeError("argument name is invalid");const o=i(n);if(o&&!S.test(o))throw new TypeError("argument val is invalid");let s=t+"="+o;if(e.maxAge!==void 0&&e.maxAge!==null){const a=e.maxAge-0;if(Number.isNaN(a)||!Number.isFinite(a))throw new TypeError("option maxAge is invalid");s+="; Max-Age="+Math.floor(a)}if(e.domain){if(!S.test(e.domain))throw new TypeError("option domain is invalid");s+="; Domain="+e.domain}if(e.path){if(!S.test(e.path))throw new TypeError("option path is invalid");s+="; Path="+e.path}if(e.expires){if(!K(e.expires)||Number.isNaN(e.expires.valueOf()))throw new TypeError("option expires is invalid");s+="; Expires="+e.expires.toUTCString()}if(e.httpOnly&&(s+="; HttpOnly"),e.secure&&(s+="; Secure"),e.priority)switch(typeof e.priority=="string"?e.priority.toLowerCase():e.priority){case"low":{s+="; Priority=Low";break}case"medium":{s+="; Priority=Medium";break}case"high":{s+="; Priority=High";break}default:throw new TypeError("option priority is invalid")}if(e.sameSite)switch(typeof e.sameSite=="string"?e.sameSite.toLowerCase():e.sameSite){case!0:{s+="; SameSite=Strict";break}case"lax":{s+="; SameSite=Lax";break}case"strict":{s+="; SameSite=Strict";break}case"none":{s+="; SameSite=None";break}default:throw new TypeError("option sameSite is invalid")}return e.partitioned&&(s+="; Partitioned"),s}function K(t){return Object.prototype.toString.call(t)==="[object Date]"||t instanceof Date}function d(t){if(typeof t!="object")return t;var n,r,e=Object.prototype.toString.call(t);if(e==="[object Object]"){if(t.constructor!==Object&&typeof t.constructor=="function"){r=new t.constructor;for(n in t)t.hasOwnProperty(n)&&r[n]!==t[n]&&(r[n]=d(t[n]))}else{r={};for(n in t)n==="__proto__"?Object.defineProperty(r,n,{value:d(t[n]),configurable:!0,enumerable:!0,writable:!0}):r[n]=d(t[n])}return r}if(e==="[object Array]"){for(n=t.length,r=Array(n);n--;)r[n]=d(t[n]);return r}return e==="[object Set]"?(r=new Set,t.forEach(function(i){r.add(d(i))}),r):e==="[object Map]"?(r=new Map,t.forEach(function(i,o){r.set(d(o),d(i))}),r):e==="[object Date]"?new Date(+t):e==="[object RegExp]"?(r=new RegExp(t.source,t.flags),r.lastIndex=t.lastIndex,r):e==="[object DataView]"?new t.constructor(d(t.buffer)):e==="[object ArrayBuffer]"?t.slice(0):e.slice(-6)==="Array]"?new t.constructor(t):t}const Q={path:"/",watch:!0,decode:t=>F(decodeURIComponent(t)),encode:t=>encodeURIComponent(typeof t=="string"?t:JSON.stringify(t))},w=window.cookieStore;function v(t,n){var u;const r={...Q,...n};r.filter??(r.filter=l=>l===t);const e=_(r)||{};let i;r.maxAge!==void 0?i=r.maxAge*1e3:r.expires&&(i=r.expires.getTime()-Date.now());const o=i!==void 0&&i<=0,s=o||e[t]===void 0||e[t]===null,a=d(o?void 0:e[t]??((u=r.default)==null?void 0:u.call(r))),c=i&&!o?ee(a,i,r.watch&&r.watch!=="shallow"):q(a);{let l=null;try{!w&&typeof BroadcastChannel<"u"&&(l=new BroadcastChannel(`nuxt:cookies:${t}`))}catch{}const h=(f=!1)=>{!f&&(r.readonly||H(c.value,e[t]))||(W(t,c.value,r),e[t]=d(c.value),l==null||l.postMessage({value:r.encode(c.value)}))},k=f=>{var y;const p=f.refresh?(y=_(r))==null?void 0:y[t]:r.decode(f.value);g=!0,c.value=p,e[t]=d(p),M(()=>{g=!1})};let g=!1;const O=!!P();if(O&&E(()=>{g=!0,h(),l==null||l.close()}),w){const f=p=>{const y=p.changed.find(b=>b.name===t),D=p.deleted.find(b=>b.name===t);y&&k({value:y.value}),D&&k({value:null})};w.addEventListener("change",f),O&&E(()=>w.removeEventListener("change",f))}else l&&(l.onmessage=({data:f})=>k(f));r.watch&&L(c,()=>{g||h()},{deep:r.watch!=="shallow"}),s&&h(s)}return c}function _(t={}){return G(document.cookie,t)}function Z(t,n,r={}){return n==null?U(t,n,{...r,maxAge:-1}):U(t,n,r)}function W(t,n,r={}){document.cookie=Z(t,n,r)}const z=2147483647;function ee(t,n,r){let e,i,o=0;const s=r?q(t):{value:t};return P()&&E(()=>{i==null||i(),clearTimeout(e)}),V((a,c)=>{r&&(i=L(s,c));function u(){o=0,clearTimeout(e);const l=n-o,h=l<z?l:z;e=setTimeout(()=>{if(o+=h,o<n)return u();s.value=void 0,c()},h)}return{get(){return a(),s.value},set(l){u(),s.value=l,c()}}})}class te{constructor(){A(this,"_baseURL");A(this,"_apiVersion")}get baseURL(){if(!this._baseURL){const n=C();this._baseURL=n.public.apiBaseUrl}return this._baseURL}get apiVersion(){if(!this._apiVersion){const n=C();this._apiVersion=n.public.apiVersion}return this._apiVersion}getFullUrl(n){return`${this.baseURL}/api/${this.apiVersion}${n}`}async makeRequest(n,r={}){const e=this.getStoredToken(),i={"Content-Type":"application/json"};r.headers&&Object.assign(i,r.headers),e&&!j(e)&&(i.Authorization=`Bearer ${e}`);try{const o=this.getFullUrl(n);console.log("ðŸŒ å‘é€è¯·æ±‚:",{url:o,method:r.method||"GET",headers:i,body:r.body});const s=await fetch(o,{...r,headers:i});console.log("ðŸ“¥ æ”¶åˆ°å“åº”:",{status:s.status,statusText:s.statusText,headers:Object.fromEntries(s.headers.entries())});const a=await s.json();if(console.log("ðŸ“„ å“åº”æ•°æ®:",a),a.code===0)return a.data;throw new $(a.code,a.message)}catch(o){throw console.error("ðŸ’¥ è¯·æ±‚å¤±è´¥:",o),o instanceof $?o:new $(-1,"ç½‘ç»œè¯·æ±‚å¤±è´¥")}}setStoredToken(n){const r=v("dormdb_token",{maxAge:86400,path:"/",sameSite:"lax",secure:!1,httpOnly:!1});if(r.value=n,window.localStorage)try{localStorage.setItem("dormdb_token",n),window.dispatchEvent(new StorageEvent("storage",{key:"dormdb_token",newValue:n,storageArea:localStorage}))}catch(e){console.error("Failed to store token in localStorage",e)}}getStoredToken(){const n=v("dormdb_token");if(n.value)return n.value;if(window.localStorage)try{const r=localStorage.getItem("dormdb_token");if(r)return this.setStoredToken(r),r}catch(r){console.error("Failed to get token from localStorage",r)}return null}removeStoredToken(){const n=v("dormdb_token");if(n.value=null,window.localStorage)try{localStorage.removeItem("dormdb_token"),window.dispatchEvent(new StorageEvent("storage",{key:"dormdb_token",newValue:null,storageArea:localStorage}))}catch(r){console.error("Failed to remove token from localStorage",r)}}async healthCheck(){return this.makeRequest("/health")}async applyDatabase(n){return this.makeRequest("/apply",{method:"POST",body:JSON.stringify({identity_key:n})})}async getPublicApplications(){return this.makeRequest("/public/applications")}async adminLogin(n){const r=await this.makeRequest("/admin/login",{method:"POST",body:JSON.stringify({password:n})}),e=JSON.parse(r);return this.setStoredToken(e.token),e}async adminLogout(){this.removeStoredToken()}async getSystemStatus(){return this.makeRequest("/admin/status")}async getApplicationStats(){return this.makeRequest("/admin/stats")}async checkAndRepairConsistency(){return this.makeRequest("/admin/repair",{method:"POST"})}async adminDeleteUser(n,r){return this.makeRequest("/admin/delete",{method:"POST",body:JSON.stringify({identity_key:n,reason:r})})}async getStudentIds(n){const r=new URLSearchParams;n!=null&&n.limit&&r.append("limit",n.limit.toString()),n!=null&&n.offset&&r.append("offset",n.offset.toString());const e=r.toString();return this.makeRequest(`/admin/student-ids${e?"?"+e:""}`)}async addStudentId(n){console.log("ðŸŒ API: å‘é€æ·»åŠ å­¦ç”Ÿè¯·æ±‚"),console.log("ðŸ“¤ API: è¯·æ±‚æ•°æ®:",n),console.log("ðŸ”— API: è¯·æ±‚URL:",this.getFullUrl("/admin/student-ids"));const r=await this.makeRequest("/admin/student-ids",{method:"POST",body:JSON.stringify(n)});return console.log("ðŸ“¥ API: å“åº”ç»“æžœ:",r),r}async deleteStudentId(n){return this.makeRequest(`/admin/student-ids/${n}`,{method:"DELETE"})}async batchImportStudentIds(n){return this.makeRequest("/admin/student-ids/batch-import",{method:"POST",body:JSON.stringify(n)})}async getStudentIdStats(){return this.makeRequest("/admin/student-ids/stats")}async getAllUsers(){return this.makeRequest("/admin/users")}async deleteUser(n,r){return this.makeRequest(`/admin/users/${n}`,{method:"DELETE",body:JSON.stringify({reason:r})})}async getAllApplicants(){return this.makeRequest("/applicants")}isAuthenticated(){const n=this.getStoredToken();return n!==null&&!j(n)}}const oe=new te;export{te as ApiClient,oe as apiClient};
